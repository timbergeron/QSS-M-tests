name: Linux CI (MinGW)

on: [push, pull_request]

jobs:
  build:
    name: x64
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo gem install apt-spy2
        sudo apt-spy2 check
        mirrors=$(apt-spy2 list | awk '{print $1}')
        for mirror in $mirrors; do
          echo "Trying mirror: $mirror"
          sudo apt-spy2 select --mirror=$mirror --commit
          # Run 'apt-get update' for the selected mirror
          if sudo apt-get update; then
            # Try to install dependencies. If successful, break out of the loop.
            if sudo apt-get install -y mingw-w64 libmad0-dev libopus-dev libvorbis-dev zlib1g-dev libvorbisfile3 libopusfile-dev libz-mingw-w64 libz-mingw-w64-dev libcurl4-openssl-dev zip; then
              echo "Dependencies successfully installed using mirror: $mirror"
              break
            else
              echo "Failed to install dependencies from mirror: $mirror. Trying next mirror."
            fi
          else
            echo "Failed to update using mirror: $mirror. Trying next mirror."
          fi
        done
        
    - name: Install Latest SDL2 from Source
      run: |
        sudo apt-get remove --purge libsdl2-dev  # Remove any existing SDL2 version
        sudo apt-get install -y build-essential cmake libasound2-dev libpulse-dev libudev-dev libx11-dev libxext-dev libxrandr-dev libxi-dev libgl1-mesa-dev
        wget https://www.libsdl.org/release/SDL2-2.28.3.tar.gz  # Replace with the latest SDL2 version
        tar -xvzf SDL2-2.28.3.tar.gz
        cd SDL2-2.28.3
        ./configure
        make
        sudo make install
        
    - name: Build
      run: |
        chmod 755 build-linux.sh
        sudo ./build-linux.sh
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QSS-M
        path: |
          Quake/QSS-M-l64.zip
